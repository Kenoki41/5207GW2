---
title: 'Group Assignment 3'
author: 'Group 2'
date: "2021/2/5"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

  In this group work, we will study the relationship between the new crown epidemic in the United States in the past year and the predictors we selected. First, we will select five predictor variables and explain why we chose these five variables. After that, we will build our theory, how the predictor variables we choose will be related to the dependent variable (COVID-19 case data). The data sets we use are county.data and covid.smooth.data_county.
  
  After establishing the theory. We will review the selected variables. We will analyze the mean, median and other data of variables and build their distribution diagrams. After that, we will use the glm() function and build a regression model to fit these predictors. Finally we will write down the main findings.
  
# Predictors select and Theory
  The five factors we used in this assignment is:
  Economic typology 2015 
  POP ESTIMATE 2018 
  POVALL_2018 
  Unemployment_rate_2018 
  Density per square mile of land area - Population 
  
  Economic typology 2015 tells us a economic type of a specific county, it's based on farming, mining, manufacturing or recreation. We believe that the economic structure plays a crucial role in the spread of COVID-19. Because the economic structure dominated by recreation will temporarily close entertainment venues due to the outbreak of the new crown epidemic. For counties that are dominated by agriculture, because the United States has a very high level of agricultural automation, the labor force is relatively not very dense. As a result, counties dominated by agriculture and counties dominated by entertainment industry may have less spread of COVID-19. As a negative case, labor-intensive industries dominated by manufacturing may be the hardest hit by COVID-19. Because factories are usually indoors and have limited floor space, it is difficult for people to maintain a certain social distance. This might caused the spread of COVID-19.
  
  By comparing the total population with the total number of COVID-19 confirmed cases, we can find out which states/counties have spread COVID-19 and summarize our findings based on other data.
  
  The total poor population is a very meaningful data. During the COVID-19 pandemic, people with high incomes can choose not to work or work from home. But for the poor, their work is mainly labor work, so they cannot work at home. This may also be a factor in the spread of COVID-19.
  
  The unemployment rate is a relatively meaningful data. Unemployment means that people do not have stable jobs, and some people choose to go out for odd jobs, which will affect the spread of COVID-19. Others have no money to pay their bills because they are unemployed. According to our speculation, this group of people does not pay much attention to the protection of their own health (such as wearing masks). This may also be a factor leading to the spread of COVID-19.
  
  Population density is a very meaningful data for the study of the spread of COVID-19. According to the US Centers for Disease Control and Prevention, most of the spread of the COVID-19 in the United States is family transmission. This means that areas with high population density may have a higher rate of transmission of the COVID, and areas with low population density may have a lower rate of transmission of COVID.
  
  To sum up, as our theory, in terms of economic structure, the more labor-intensive economic structure, we speculate that the higher the transmission rate of COVID-19. For the poor, we believe that areas with more poor people have a higher transmission rate of COVID-19. The spread of COVID-19 will also be high in areas with high unemployment. The spread of COVID-19 will be higher in areas with higher population density. Finally, we will compare them based on the total population.
  

```{r}
library(tidyverse)
# load data
confirmed.cases.data <- read.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv")
#independent variables
google.mobility <- read.csv('https://www.gstatic.com/covid19/mobility/Global_Mobility_Report.csv?cachebust=722f3143b586a83f') %>% filter(country_region == 'United States')
county.data <- read.csv('https://raw.githubusercontent.com/JieYingWu/COVID-19_US_County-level_Summaries/master/data/counties.csv')
load("Data/google.mobility.RData")
```


# clean data
```{r}
library(DataCombine)
confirmed.cases.data2 <- confirmed.cases.data %>%
dplyr::rename(state = Province_State,county = Admin2) %>%
dplyr::select(-UID, -iso2, -iso3, -code3, -Lat, -Long_, -Combined_Key, -Country_Region) %>%
gather(date, confirmed.cases,-state,-county,-FIPS) %>%
dplyr::mutate(date = gsub('X', '', date),
              date = as.Date(as.character(date), "%m.%d.%y"),
              county_state = paste0(county, ', ', state)) %>%
arrange(county_state, date) %>%
dplyr::mutate(lag = slide(.,
              Var = 'confirmed.cases',
              NewVar = 'new',
              GroupVar = 'county_state',
              slideBy = -1)[,'new'], new.cases = confirmed.cases - lag)
```
```{r}

library(zoo) #install.packages("zoo")
## calculate rolling averages and remove non-states
covid.smooth.data_county <- confirmed.cases.data2 %>%
dplyr::group_by(county_state, date) %>%
dplyr::summarise(new.cases = sum(new.cases)) %>%
dplyr::group_by(county_state) %>%
dplyr::mutate(cases_14days = zoo::rollmean(new.cases,k = 14, fill = 0)) %>%
dplyr::ungroup() %>%
mutate() %>%
merge(confirmed.cases.data2 %>%
dplyr::select(county_state, date, county, state)) %>%
filter(!state %in% c('American Samoa','Diamond Princess','Grand Princess','Guam','Northern Mariana Islands','Puerto Rico','Virgin Islands'))
#save(covid.smooth.data_county, file = 'Data/Day 5/covid.RData')
```

```{r}
names(google.mobility)
#sub_region_1 州
#sub_region_2 县
#Retail & recreation餐馆、咖啡馆、购物中心、主题公园、博物馆、图书馆和电影院等场所的流动趋势。
#park 流动趋势的地方，如地方公园，国家公园，公共海滩，码头，狗公园，广场和公共花园。
```


```{r loading data}

load('Data/covid.RData')
load("Data/county.data.RData")
load("Data/google.mobility.RData")

```



# process the table covid.smooth.data_county
```{r}
load("Data/provided_data.Rdata")
covid.smooth.data_county$new.cases[is.na(covid.smooth.data_county$new.cases)] <- 0
 covid.smooth.data_county.1 <- covid.smooth.data_county%>%
  group_by(county_state,county, state)%>%
  summarise(tot_cases = sum(new.cases))
 
```



# Process the data in county.data
```{r}

#remove suffix
patterns <- c(" County| Parish| Borough| City and Borough| Municipality| Census Area| Parish")
county.data.1 <- county.data%>%
  mutate(county_name = gsub(patterns, "", Area_Name))%>%
  dplyr::select(FIPS,  Area_Name, county_name, State, Economic_typology_2015, POP_ESTIMATE_2018, POVALL_2018, Unemployment_rate_2018, Density.per.square.mile.of.land.area...Population)




#remove the city suffix except some specific cities
for(i in 1:nrow(county.data.1)){
  
  if(county.data.1[i,]$county_name != "Baltimore city" & county.data.1[i,]$county_name != "St. Louis city" & county.data.1[i,]$county_name != "Fairfax city" & county.data.1[i,]$county_name != "Franklin city" & county.data.1[i,]$county_name != "Richmond city" & county.data.1[i,]$county_name != "Roanoke city"){
    county.data.1[i,]$county_name = gsub(" city", "", county.data.1[i,]$county_name)
  }
  
  
}


county.data.1$county_name = gsub(" city", " City", county.data.1$county_name)


#add state suffix
state_name <- ""
for(i in 1:nrow(county.data.1)){
  
  if(county.data.1[i,]$FIPS != 0 & county.data.1[i,]$FIPS%%1000 == 0){
    state_name <- county.data.1[i,]$Area_Name
    
    
  }
  else{
    county.data.1$county_state[i] = paste0(county.data.1[i,]$county_name, ", ", state_name)
  }
  
  
  
  
 
  
}


county.data.2 <- county.data.1%>%
  dplyr::select(FIPS, county_state, Economic_typology_2015, POP_ESTIMATE_2018, POVALL_2018, Unemployment_rate_2018, Density.per.square.mile.of.land.area...Population)



```

# merge county with covid
```{r}
covid.with.count.data <- merge(county.data.2,
covid.smooth.data_county.1 , by="county_state", duplicateGeoms = TRUE)
```




## descriptive analysis

### Look at some of the descriptive results for your chosen variables, including their distributions as well
as their relationship to the confirmed cases variable. Plot these.
```{r Analysis}
#提取5个自变量，1个因变量，避免污染原数据
vars_chosen <- covid.with.count.data  %>% 
  dplyr::rename(economic_type = Economic_typology_2015, 
                population    = POP_ESTIMATE_2018 ,
                poverty       = POVALL_2018 ,
                unemployment  = Unemployment_rate_2018 ,
                pop_density   = Density.per.square.mile.of.land.area...Population,
                tot_cases     = tot_cases) %>%
  dplyr::select(economic_type, population, poverty, unemployment,
                pop_density, tot_cases)
  
vars_chosen$economic_type <- factor(vars_chosen$economic_type)
```


```{r descriptive analysis}
variable <-c('economic_type','population','poverty','unemployment','pop_density')
summary(vars_chosen[variable], na.rm=TRUE)

library(psych)
describe(vars_chosen[variable])
```

```{r convert The total cases into a categorical variable}
tot.margins <- vars_chosen %>%
                mutate(tot.cat = dplyr::case_when(tot_cases < 864 ~ '864 and less',
                                            tot_cases >= 864 & tot_cases < 2111 ~
                                            '864 - 2,111',
                                            tot_cases >= 2111 & tot_cases < 5445 ~
                                            '2,111 - 5,445',
                                            tot_cases >= 5445 ~ '5,445 and over'),
                      tot.cat = factor(tot.cat, levels = c('864 and less',
                                                              '864 - 2,111',
                                                              '2,111 - 5,445',
                                                           '5,445 and over')))
```

```{r Distributions economic_type}
eco_g <- ggplot(data = vars_chosen) + 
  geom_bar(
    mapping = aes(x = economic_type, fill = economic_type), #清洗后用病例数对应观察分布
    show.legend = FALSE,
    width = 1,
    na.rm = TRUE
  ) + 
  theme(aspect.ratio = 1) +
  labs(x = NULL, y = NULL)

eco_g + coord_flip()
eco_g + coord_polar()

#ggplot(data = vars_chosen, mapping = aes(x = tot_cases)) +
#  geom_freqpoly(mapping = aes(color = economic_type), binwidth = 1000000)


ggplot(data = tot.margins) +
  geom_count(mapping = aes(x = economic_type, y = tot.cat,color  = economic_type), na.rm = TRUE)



```


```{r Distributions population}
#Create CATegorical variable

(tot.margins <- tot.margins %>%
  mutate(pop.cate.1=dplyr::case_when(population < 5000 ~ '5,000 and less',
                   population >= 5000 & population < 100000 ~
                   'Between 5,000 & 100,000',
                   population >= 100000 & population < 500000 ~
                   'Between 100,000 & 500,000',
                   population >= 500000 ~ '500,000 and over'),
         pop.cate.1=factor(pop.cate.1, levels = c('5,000 and less',
                                        'Between 5,000 & 100,000',
                                        'Between 100,000 & 500,000',
                                        '500,000 and over'))))
(tot.margins %>%
  group_by(pop.cate.1) %>%
  tally() %>%
  ggplot(aes(x = pop.cate.1, y = n, fill = pop.cate.1)) +
  geom_bar(stat = 'identity') +
  labs(title = 'City size distribution',
        x = 'City population size\n',
        y = 'Number of cities\n') +
  theme(axis.title = element_text(face = 'bold', size=12),
        axis.text.x = element_text(size = 7)) +
  coord_flip())

ggplot(data = tot.margins) +
  geom_count(mapping = aes(x = pop.cate.1, y = tot.cat, color  = pop.cate.1))+
  coord_flip()

```


```{r Distributions poverty}
(tot.margins <- tot.margins %>%
  mutate(pov.cate.1=dplyr::case_when(poverty < 500 ~ '5,00 and less',
                   poverty >= 500 & poverty < 15000 ~
                   '5,00 - 15,000',
                   poverty >= 15000 & poverty < 50000 ~
                   '15,000 - 50,000',
                   poverty >= 50000 & poverty < 200000 ~
                   '50,000 - 200,000',
                   poverty >= 200000 ~ '200,000 and over'),
         pov.cate.1=factor(pov.cate.1, levels = c('5,00 and less',
                                        '5,00 - 15,000',
                                        '15,000 - 50,000',
                                        '50,000 - 200,000',
                                        '200,000 and over'))))

(tot.margins%>%
  group_by(pov.cate.1) %>%
  tally() %>%
  ggplot(aes(x = pov.cate.1, y = n, fill = pov.cate.1)) +
  geom_bar(stat = 'identity') +
  labs(title = 'Poverty distribution',
        x = 'Poverty population\n',
        y = 'Number of cities\n') +
  theme(axis.title = element_text(face = 'bold', size=12),
        axis.text.x = element_text(size = 7)))

ggplot(data = tot.margins) +
  geom_count(mapping = aes(x = pov.cate.1, y = tot.cat))+
  coord_flip()


```


```{r Distributions unemployment}
ggplot(data = tot.margins) +
  geom_bar(mapping = aes(x = unemployment, fill = unemployment), na.rm = TRUE) +
  theme_minimal()

ggplot(data = tot.margins, mapping = aes(x = tot.cat, y = unemployment)) +
  geom_boxplot(na.rm = TRUE) +
  coord_flip()
```

```{r Distributions pop_density}
library(Hmisc)
# 插补均值
tot.margins$pop_density <- impute(tot.margins$pop_density,mean)

(tot.margins <- tot.margins %>%
    mutate(pde.cate.1=dplyr::case_when(pop_density < 44 ~ '44 and less',
                   pop_density >= 44 & pop_density < 121 ~
                   '44 - 121',
                   pop_density >= 121 & pop_density < 261 ~
                   '121 - 261',
                   pop_density >= 261 ~ '261 and over'),
         pde.cate.1=factor(pde.cate.1, levels = c('44 and less',
                                        '44 - 121',
                                        '121 - 261',
                                      '261 and over'))))
  
(tot.margins%>% 
  group_by(pde.cate.1) %>%
  tally() %>%
  ggplot(aes(x = pde.cate.1, y = n, fill = pde.cate.1)) +
  geom_bar(stat = 'identity') +
  labs(title = 'City population density distribution',
        x = 'Density\n',
        y = 'Number of cities\n') +
  theme(axis.title = element_text(face = 'bold', size=12),
        axis.text.x = element_text(size = 7)) +
  coord_flip())

ggplot(data = tot.margins) +
  geom_count(mapping = aes(x = pde.cate.1, y = tot.cat, color  = pde.cate.1))+
  coord_flip()
```

## Patterns of 5 selected factors and total case

```{r poverty_v_opiates_mortality, warning=FALSE, echo=FALSE, message=FALSE, fig.cap = "Smoothed mortality rate as a function of proportion of families below the poverty rate and the rate of opiate prescriptions in each county. Each cell represents the mean mortality rate of a group of counties with similar values for poverty and opiate presriptions.\\label{fig:poverty_v_opiates_mortality}", fig.height= 4.5, fig.width=4, fig.align="center"}
library(ggplot2)
library(scales)
  ggplot(covid.with.count.data,
       aes(x = poverty / population, y = unemployment / population,
           z = tot_cases / population, alpha = tot_cases / population)) +
  stat_summary_2d(fun = mean, bins = 50) + 
  scale_fill_gradient2(low = 'grey', 
                      high = 'dark red', midpoint = 21) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) + 
  labs(title = 'Poverty and Unemployment-related COVID',
       y = 'Poverty (%)',
       x = 'Unemployment rate (%)',
       fill = 'Poverty and Unemployment-related COVID') + 
  theme_minimal() +
  theme(plot.title = element_text(size = 10, face = "bold", hjust = 0),
          strip.background = element_blank(),
          panel.border = element_blank(),
          panel.grid = element_blank(),
          axis.title = element_text(size = 8),
          legend.position = "bottom",
          axis.text = element_text(size = 7))
    
```



## fitting model
```{r fit the first model to county, warning=FALSE, message=FALSE, cache=FALSE}
library(tidyverse)
covid.with.count.data.1 <- vars_chosen %>%
  mutate(z.economic = scale(economic_type)) %>%
  mutate(z.population = scale(population)) %>% 
  mutate(z.poverty = scale(poverty)) %>% 
  mutate(z.unemployment = scale(unemployment))%>%
  mutate(z.density = scale(pop_density))
```

```{r fitting model}
library(arm)
covid19.model <- glm(tot_cases ~ z.economic + z.population 
                     + z.poverty + z.unemployment + z.density,
                     family=poisson(link = log), #泊松或者改成逻辑
                     data=covid.with.count.data.1)

display(covid19.model)
summary(covid19.model)
plot(covid19.model)





```









